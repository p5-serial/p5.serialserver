<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: classes/SerialPort.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: classes/SerialPort.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileOverview SerialPort class that gets created when new serial port is opened. Maintains list of connected Client objects to forward data received from the serial port.
 *
 * @author Shawn Van Every
 * @author Jiwon Shin
 *
 * @requires NPM:serialport
 * */

let sp = require("serialport");

/**
 * Represents a serialport object. Maintains an array of {@link Client Client} objects subscribed to the serial port.
 * @see https://www.npmjs.com/package/serialport
 * */
class SerialPort {

    /**
     * creates a SerialPort object
     * @constructor
     * @param {serialport} serialport - serialport object
     * @param {Object} serialoptions - JSON object of options for the serialport object
     * @property {Boolean} LOGGING - sets whether to console.log detailed information
     * @property {String} serialPortName - name of the connected serialport
     * @property {Object} serialOptions - JSON array of options for the serialport
     * @property {Client[]} messageListeners - array of subscribed {@link Client Client} objects
     * */
    constructor(serialport, serialoptions) {

        this.LOGGING = true;

        this.serialPortName = serialport;
        this.serialOptions = serialoptions;

        this.serialPort = null;

        this.messageListeners = [];

        this.openSerial();

        this.logit(`initialize with serial port ${this.serialPortName}`);
    }

    /**
     * add a web client to messageListeners array
     * @param {Client} client - {@link Client Client} object subscribing to the SerialPort
     * */
    addClient(client){
        this.messageListeners.push(client);

        console.log(`total number of ${this.messageListeners.length} clients subscribed`);
        //this.onMessage({method: 'clientNumber', data: this.messageListeners.length});
    }

    /**
     * remove client from messageListeners array to unsubscribe client
     * @param {Client} client - {@link Client Client} object unsubscribing to the SerialPort
     * */
    removeClient(client){
        this.messageListeners = this.messageListeners.filter(clientToRemove => clientToRemove !== client);
        console.log(`removeClient - total number of ${this.messageListeners.length} clients subscribed`);
    }

    /**
     * Forwards message emitted by SerialPort events to the susbscribed clients in the messageListeners array
     * @param {Object} msg - JSON object containing message method and data
     * */
    onMessage(msg){
        this.messageListeners.forEach(client => client.sendit(msg));
    }

    /**
     * Opens SerialPort of serialPortName with serialOptions.
     * Sets serialport event listeners of method 'data', 'close' and 'error' and sends messages to the client via onMessage function
     * */
    openSerial(){
       let self = this;

        if(!self.serialOptions.hasOwnProperty('autoOpen')){
            self.serialOptions.autoOpen = false;
        }

        self.serialPort = new sp(self.serialPortName, self.serialOptions,
            function (err) {
                if (err) {
                    console.log(err);
                    self.onMessage({method: 'error', data: err});
                }
            }
        );

        self.serialPort.on('data', function(incoming){
            for(let i = 0; i &lt; incoming.length; i++){
                self.onMessage({method: 'data', data: incoming[i]});
            }
        });

        self.serialPort.on('close', function(data){
            self.logit("serialPort.on close");
            self.onMessage({method: 'close', data: data});

            for(let i = 0; i &lt; self.messageListeners.length; i++){
                let serialIndex = self.messageListeners[i].serialPortsList.indexOf(self.serialPortName);

                console.log("need to take out " + self.serialPortName + " from client at index " + serialIndex);

                self.messageListeners[i].serialPorts.splice(serialIndex, 1);
                self.messageListeners[i].serialPortsList.splice(serialIndex, 1);
            }

            self.closeSerial();
        });

        self.serialPort.on('error', function(data){
            self.logit("serialPort.on error " + data, true);
            self.onMessage({method: 'error', data: data});
        });

        self.serialPort.open(function(err){
            self.logit("serialPort.open");

            if(err){
                console.log(err);
                self.onMessage({method: 'error', data: "Couldn't open port: " + this.serialport});
            }else{
                self.onMessage({method: 'openserial', data: {}});
            }
        });
    }

    /**
     * closes the serialport connection and sends message to the connected clients that the serialport is closed.
     * */
    closeSerial(){

        let self = this;

        //need to emit back to client that this port was forcefully closed

        self.logit(`closeSerial for ${self.serialPortName}`);

        if(self.serialPort != null &amp;&amp; typeof self.serialPort === "object" &amp;&amp; self.serialPort.isOpen){
            self.logit("serialPort != null &amp;&amp; serialPort.isOpen so close");
            self.logit("serialPort.flush, drain, close");

            self.serialPort.flush();
            self.serialPort.drain();
            self.serialPort.close(
                function(error) {
                    if (error) {
                        self.onMessage({method:'error', data:error});
                        console.log(error);
                    }
                }
            );

            self.onMessage({method: 'close', data: `${self.serialPort} is closed`});

            self.serialPort = null;
        }

        // if (self.serialPort != null &amp;&amp; typeof self.serialPort === "object" &amp;&amp; self.serialPort.isOpen) {
        //     self.logit("serialPort != null &amp;&amp; serialPort.isOpen is true so serialPort = null");
        //
        //     self.serialPort = null;
        // }

        self.logit("serialPort closed");
    }

    /**
     * console.log log messages when LOGGING == true
     * @function logit
     * @param {String} mess - String to log when LOGGING == true*/
    logit(mess){
        if(this.LOGGING){
            console.log(mess);
        }
    }
};

module.exports = SerialPort;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Client.html">Client</a></li><li><a href="SerialPort.html">SerialPort</a></li></ul><h3>Events</h3><ul><li><a href="Client.html#event:message">message</a></li></ul><h3>Global</h3><ul><li><a href="global.html#clients">clients</a></li><li><a href="global.html#LOGGING">LOGGING</a></li><li><a href="global.html#logit">logit</a></li><li><a href="global.html#serialPorts">serialPorts</a></li><li><a href="global.html#serialPortsList">serialPortsList</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#stop">stop</a></li><li><a href="global.html#wss">wss</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sun Jul 17 2022 21:38:31 GMT-0400 (Chile Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
